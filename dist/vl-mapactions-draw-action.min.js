import Draw from"ol/src/ol/interaction/Draw";import Overlay from"ol/src/ol/Overlay";import{LineString,Polygon}from"ol/src/ol/geom";import{unByKey}from"ol/src/ol/Observable";import{MapAction}from"./vl-mapactions-mapaction";import{SnapInteraction}from"./vl-mapactions-snap-interaction";export class DrawAction extends MapAction{constructor(t,e,o,n){const i=[],r=n||{};r.source=t.getSource(),r.type=e;const s=new Draw(r);i.push(s),r.snapping&&i.push(new SnapInteraction(r.snapping.layer||t)),s.on("drawstart",t=>{if(r.measure){const e=t.feature;r.measure="object"==typeof r.measure?r.measure:{},r.measure.tooltip=r.measure.tooltip||{};const o=document.createElement("div");o.setAttribute("class","measure-tooltip"),this.tooltip=new Overlay({offset:r.measure.tooltip.offset||[-15,10],positioning:"bottom-center"}),this.map.addOverlay(this.tooltip),this.measurePointermoveHandler=this.map.on("pointermove",()=>{this._showMeasureTooltip(e,this.tooltip,o)})}}),s.on("drawend",e=>{const n=e.feature;o(n,(function(){try{t.getSource().removeFeature(n)}catch(e){const o=t.getSource().on("addfeature",(function(e){t.getSource().removeFeature(e.feature),unByKey(o)}))}})),this._cleanUp()}),super(i),this.drawOptions=r,this.drawInteraction=s}deactivate(){this._cleanUp(),super.deactivate()}_cleanUp(){this.drawOptions.measure&&(unByKey(this.measurePointermoveHandler),this._removeTooltip())}_removeTooltip(){this.tooltip&&(this.map.removeOverlay(this.tooltip),this.tooltip=void 0)}_showMeasureTooltip(t,e){if(this.tooltip){const o=this._getLengthOfLastSegment(t.getGeometry());0!==o&&(e.textContent=o+" m",this.tooltip.setElement(e),this.tooltip.setPosition(t.getGeometry().getLastCoordinate()))}}_getLengthOfLastSegment(t){return t&&t instanceof LineString?new LineString(this._getCoordinatesOfLastSegment(t)).getLength().toFixed(2):t&&t instanceof Polygon?new LineString(this._getCoordinatesOfLastSegment(t.getLinearRing(0))).getLength().toFixed(2):0}_getCoordinatesOfLastSegment(t){const e=t.getCoordinates().length;return t.getCoordinates().slice(e-2)}}
